<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>HTML Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    background: #000;
    color: #00ff00;
    font-family: monospace;
}

#terminal {
    padding: 10px;
    height: 100vh;
    overflow-y: auto;
    box-sizing: border-box;
}

.line {
    display: flex;
    white-space: pre-wrap;
}

.prompt {
    margin-right: 6px;
}

.input {
    background: none;
    border: none;
    outline: none;
    color: inherit;
    font-family: inherit;
    flex: 1;
}
</style>
</head>

<body>
<div id="terminal"></div>

<script>
// ================== STATE ==================
const terminal = document.getElementById("terminal");

let history = [];
let historyIndex = 0;
let cwd = "/home/user";

// ---------------- FILESYSTEM ----------------
let fs = JSON.parse(localStorage.getItem("fs")) || {
    "/": ["home", "libs"],
    "/home": ["user"],
    "/home/user": ["main.hx", "project.xml"],
    "/libs": []
};

let haxelib = JSON.parse(localStorage.getItem("haxelib")) || [];

function save() {
    localStorage.setItem("fs", JSON.stringify(fs));
    localStorage.setItem("haxelib", JSON.stringify(haxelib));
}

// ================== TERMINAL ==================
function print(text = "") {
    const div = document.createElement("div");
    div.textContent = text;
    terminal.appendChild(div);
    terminal.scrollTop = terminal.scrollHeight;
}

function promptText() {
    return `user@html:${cwd}$`;
}

function newLine() {
    const line = document.createElement("div");
    line.className = "line";

    const prompt = document.createElement("span");
    prompt.className = "prompt";
    prompt.textContent = promptText();

    const input = document.createElement("input");
    input.className = "input";

    line.append(prompt, input);
    terminal.appendChild(line);
    input.focus();

    input.addEventListener("keydown", e => {
        if (e.key === "Enter") {
            const cmd = input.value.trim();
            history.push(cmd);
            historyIndex = history.length;
            input.disabled = true;
            runCommand(cmd);
            newLine();
        }

        if (e.key === "ArrowUp") {
            if (historyIndex > 0) historyIndex--;
            input.value = history[historyIndex] || "";
        }

        if (e.key === "ArrowDown") {
            if (historyIndex < history.length) historyIndex++;
            input.value = history[historyIndex] || "";
        }
    });

    terminal.scrollTop = terminal.scrollHeight;
}

// ================== COMMANDS ==================
function runCommand(cmd) {
    if (!cmd) return;

    const args = cmd.split(" ");
    const base = args[0];

    switch (base) {
        case "help":
            print("Comandos disponíveis:");
            print("help clear ls cd pwd echo date whoami");
            print("haxelib install <lib>");
            print("haxelib list");
            print("haxelib remove <lib>");
            print("haxelib search <lib>");
            break;

        case "clear":
            terminal.innerHTML = "";
            break;

        case "ls":
            print((fs[cwd] || []).join("  "));
            break;

        case "cd":
            changeDir(args[1]);
            break;

        case "pwd":
            print(cwd);
            break;

        case "echo":
            print(args.slice(1).join(" "));
            break;

        case "date":
            print(new Date().toString());
            break;

        case "whoami":
            print("user");
            break;

        case "haxelib":
            handleHaxelib(args);
            break;

        default:
            print(`comando não encontrado: ${base}`);
    }
}

// ================== CD ==================
function changeDir(path) {
    if (!path || path === "~") {
        cwd = "/home/user";
        return;
    }

    if (path === "..") {
        if (cwd !== "/") {
            cwd = cwd.split("/").slice(0, -1).join("/") || "/";
        }
        return;
    }

    const newPath = path.startsWith("/")
        ? path
        : cwd + "/" + path;

    if (fs[newPath]) {
        cwd = newPath;
    } else {
        print(`cd: diretório não encontrado: ${path}`);
    }
}

// ================== HAXELIB ==================
function handleHaxelib(args) {
    const action = args[1];
    const lib = args[2];

    if (!action) {
        print("Uso: haxelib <install|list|remove|search>");
        return;
    }

    switch (action) {
        case "install":
            if (!lib) return print("Informe o nome da lib.");
            if (haxelib.includes(lib))
                return print(`${lib} já está instalada.`);

            haxelib.push(lib);
            fs["/libs"].push(lib);
            save();
            print(`Instalando ${lib}...`);
            print(`${lib} instalado.`);
            break;

        case "list":
            if (!haxelib.length) return print("Nenhuma lib instalada.");
            haxelib.forEach(l => print(l));
            break;

        case "remove":
            if (!lib) return print("Informe o nome da lib.");
            if (!haxelib.includes(lib))
                return print(`${lib} não está instalada.`);

            haxelib = haxelib.filter(l => l !== lib);
            fs["/libs"] = fs["/libs"].filter(l => l !== lib);
            save();
            print(`${lib} removida.`);
            break;

        case "search":
            if (!lib) return print("Informe o nome da lib.");
            print(`Encontrado: ${lib}`);
            break;

        default:
            print("Comando haxelib inválido.");
    }
}

// ================== START ==================
print("HTML Terminal Sandbox");
print("Haxelib fake carregado");
print("Digite 'help'");
newLine();
</script>
</body>
</html>
